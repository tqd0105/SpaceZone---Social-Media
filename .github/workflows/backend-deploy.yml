name: ğŸš€ Backend CI/CD

on:
  push:
    branches: [ main, master ]
    paths:
      - 'spacezone-backend/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'spacezone-backend/**'

  # Cho phÃ©p cháº¡y manual
  workflow_dispatch:

jobs:
  # Test job
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./spacezone-backend

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ./spacezone-backend/package-lock.json

      - name: ğŸ“¥ Install dependencies
        run: npm install

      - name: ğŸ§ª Run tests (náº¿u cÃ³)
        run: npm test
        continue-on-error: true

      - name: ğŸ” Check server start
        run: |
          echo "Checking server can start..."
          timeout 10s npm start || echo "Server start check completed"

  # Build Docker image (náº¿u deploy báº±ng Docker)
  build-docker:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./spacezone-backend
          file: ./spacezone-backend/Dockerfile
          push: false
          tags: spacezone-backend:latest

  # Deploy to Render/Railway/Vercel (example for Render)
  deploy-render:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Deploy to Render
        run: |
          echo "ğŸš€ Triggering deployment..."
          # Thay tháº¿ báº±ng webhook URL tá»« Render
          curl -X POST "${{ secrets.RENDER_DEPLOY_WEBHOOK }}"